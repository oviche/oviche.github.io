---
layout: post
title: "Cyber espionage on Tibetian citizens"
date: 2023-01-25
tags: x86 malware 
description: The post shows the details of a malware attack that was developed by a Chinese state-sponsored group to spy on Tibetian citizens. 
---

# Intro

- This post will mainly include the details of my analysis of the stages of the attack, malware classification, tool tracking, and indicators of compromise.  

# Description of kill chain

- The following diagram shows the flow of attack from the initial access to communication with the C2 server.
  
  ![img]({{ '/assets/images/espionage_tibet_image/lowzero_1.png' | relative_url }}){: .center-image }*(**Kill-chain diagram**)*

  ## Delivery
  
  - The malware is delivered as an RTF document, maybe through phishing mail, that contains an application form written in the chinese-tibetian language as it appears below.
    
    ![img]({{ '/assets/images/espionage_tibet_image/lowzero_2.png' | relative_url }}){: .center-image }*(**RTF document page [1]**)*
 
    ![img]({{ '/assets/images/espionage_tibet_image/lowzero_3.png' | relative_url }}){: .center-image }*(**RTF document page [2]**)*

  - This may indicate that this attack is targeting Tibetan people.

  <p></p>
  ## Exploitation
  
  - This RTF document contains 2 embedded objects one of them with the name of **Equation.2\x00\x124Vx\x90\x124VxvT2**. After searching this name, I find that this RTF is generated by a tool called **Royal Road** which usually includes one of the exploits which target the equation editor vulnerabilities of the office.
  
  - This RTF document contains an exploit that takes advantage of  RCE vulnerabilities in the equation editor of Microsoft Office; which allows one to write mathematical equations and formulas.
  
  
  
  ## Installation & Reconnaissance
  
  - Once the exploit is triggered, an executable (the second embedded object in the RTF document) is decrypted and executed which executes and injects a shellcode inside **RUNDLL32.exe**.
 
  - Then the shellcode unpack, load, and execute a dll file which acts as a backdoor.

  - This backdoor collects various host information from the infected host which may be used to check if the machine is an interesting target or not.
  
  
  ## Command and Control
 
  - The backdoor communicates with the C2 server on port 110 and sends the collected information and waits till receiving one or more commands to get executed.
   

# Description of functionality

- This section will cover a detailed analysis of the components of the attack kill chain that's mentioned previously.
 
  ## RTF document
  
  - The RTF document holds two embedded objects **ghb4nrwmp.wmf** and **Equation.2\x00\x124Vx\x90\x124VxvT2** as shown below.
     
     ![img]({{ '/assets/images/espionage_tibet_image/lowzero_4.png' | relative_url }}){: .center-image }*(**RTF document's embedded objects**)*
  
  - Based on my search, the second object name is usually the name of the embedded exploit that targets the equation editor of Microsoft office to decode and execute the first object, **ghb4nrwmp.wmf** . 
    
  - This was confirmed by using any.run sandbox to check the effect of opening this document with word office. For example, the below screenshot shows that by opening the document, the equation editor **EQNEDT32.exe** got executed then **rundll32.exe** spawned from it.  
  
     ![img]({{ '/assets/images/espionage_tibet_image/lowzero_5.png' | relative_url }}){: .center-image }*(**Equation editor spawning rundll32.exe**)*  
    
  ## The embedded Executable (ghb4nrwmp.wmf)
  
  - Once the exploit gets triggered, it decodes and executes the **ghb4nrwmp.wmf** object.
  
  - Using **xorsearch** command I find this file is encrypted with xor and the key is 0xfc.
  
     ![img]({{ '/assets/images/espionage_tibet_image/lowzero_6.png' | relative_url }}){: .center-image }*(**The Xorsearch command's output**)*  
  
  - Also, as appear below, many of the bytes in the hex editor show a lot of 0xfc which indicates that these original bytes are equal to zero(s) so with xoring with 0xfc they turn to become 0xfc.  
  
     ![img]({{ '/assets/images/espionage_tibet_image/lowzero_7.png' | relative_url }}){: .center-image }*(**The Hex editor view of file**)* 

  - After decoding the file, the e-magic replacing **MZ** to **NZ** was corrupted maybe to avoid detection or to thwart static analysis tools as the following.
  
     ![img]({{ '/assets/images/espionage_tibet_image/lowzero_8.png' | relative_url }}){: .center-image }*(**The corrupted magic value**)*
  
    
   ## Injected shellcode
  
  - here
  
  
   ## Backdoor DLL file
  
  - here


