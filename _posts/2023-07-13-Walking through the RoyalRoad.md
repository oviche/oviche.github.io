---
layout: post
title: "Walking through the Royal Road"
date: 2023-07-13
tags: [x86, Shellcode, Exploitation, Malware Analysis] 
description: The post put a spotlight on the malicious RTF generated by the famous Royal Road weaponizer. 
---

# Introduction

Recently, numerous malicious RTF files generated by the Royal Road \_\_RTF weaponizer tool\_\_, are spotted in the wild to deliver attacks attributed to China State-Sponsored actors. So I decided through this post to analyze one of the files used in [Cyber Espionage on Tibetian Citizens](https://oviche.github.io/2023/01/Cyber-espionage-on-Tibetian-citizens/) to explain how to identify the attached exploit and spotlight some shellcode features.

# Overview

The first view of the RTF file shows the following two embedded objects: 
 
 - **ghb4nrwmp.wmf**
 - **Equation.2\x00\x124Vx\x90\x124VxvT2**.

![img]({{ '/assets/images/RoyalRoad/rtf1.png' | relative_url }}){: .center-image }*(**RTF document's embedded objects**)*

When the file is opened, the process **EQNEDT32.exe** gets executed and spawns another **EQNEDT32.exe** process. Then, the child **EQNEDT32.exe** process launches a subprocess **rundll32.exe**.

![img]({{ '/assets/images/RoyalRoad/rtf2.png' | relative_url }}){: .center-image }*(**The process tree when opening the RTF file**)*

The previous process tree can indicate that the file contains an exploit that targets the **EQNEDT32.exe**. This executable represents the **equation editor** of **Microsoft Office** that is responsible for interpreting the embedded equations inside the document files.

Probably the exploit will be embedded in the equation object which is called **Equation.2\x00\x124Vx\x90\x124VxvT2**.

# Setup a debugging environment

Debugging the **EQNEDT32.exe** process, will help us later to identify the **common vulnerabilities and exposures (CVE)** that the exploit is targetting and its contents' bytes.

This can be achieved by taking advantage of the [**Image File Execution Options (IFEO)**](https://www.malwarebytes.com/blog/news/2015/12/an-introduction-to-image-file-execution-options) feature will allow the debugger to attach the process **EQNEDT32.exe** as soon as it starts.

![img]({{ '/assets/images/RoyalRoad/rtf3.png' | relative_url }}){: .center-image }*(**Creating key for EQNEDT32 process under IFEO in registry**)*

# Determining the common vulnerabilities and exposures (CVE)

My approach for identifying the **CVE** will depend on the vulnerable function address and the RTF structure field that contains the exploit bytes, as explained below.

 ## Finding the vulnerable function

 heloo 
 
 ## Locating the exploit within RTF structure 
 
 hello
 
Conclusion,  




















